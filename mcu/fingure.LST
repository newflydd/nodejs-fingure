C51 COMPILER V9.52.0.0   FINGURE                                                           03/07/2017 18:03:37 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE FINGURE
OBJECT MODULE PLACED IN fingure.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE fingure.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /*
   2           * @CreateTime: Mar 3, 2017 4:25 PM 
   3           * @Author: Smith Ding 
   4           * @Contact: newflydd@gmail.com 
   5           * @Last Modified By: Smith Ding
   6           * @Last Modified Time: Mar 3, 2017 4:46 PM
   7           * @Description: æœ¬è½¯ä»¶ç”¨æ¥å°†é¢æ¿ä¸æŒ‡çº¹æ¨¡å—è¿›è¡Œé€šä¿¡
   8           * @Company: JIANGSU SAIYANG MECHANICAL & ELECTRICAL TECHNOLOGY CO.,LTD
   9           */
  10          
  11          #include <reg52.h>
  12          #include <intrins.h>
  13          #include "uart.h"
  14          #include "fingure.h"
  15          #include "event.h"
  16          
  17          void delay(uint num){
  18   1          while(num--);
  19   1      }
  20          
  21          //å¯åŠ¨åˆå§‹åŒ–
  22          void initMain(){
  23   1          //åˆå§‹åŒ–å‘é€æŒ‡ä»¤å‰7ä¸ªbyte
  24   1          int pos;
  25   1          for(pos = 0; pos < 7; pos ++){
  26   2              sendBuffer[pos] = sendPackageHeader[pos];
  27   2          }
  28   1      
  29   1          //å°†ä¸²å£æ¥å—å¯„å­˜å™¨çš„æ•°æ®é•¿åº¦ç½®0
  30   1          receiveBufferLength = 0;
  31   1      
  32   1          EA = 1;     //æ€»ä¸­æ–­å¼€å…³æ‰“å¼€
  33   1      }
  34          
  35          void main(){
  36   1          initUart();
  37   1          initMain();
  38   1      
  39   1          //åˆå§‹åŒ–æŒ‡ä»¤ä¸º:0x11ï¼Œå‘æŒ‡çº¹æ¨¡å—å‘é€é‡‡é›†æŒ‡çº¹ç”¨æ¥éªŒè¯çš„å‘½ä»¤
  40   1          sendCmdStatus = ACTION_GET_IMAGE_FOR_CHECK;
  41   1      
  42   1          while(1){
  43   2              /* ä¸»å¾ªç¯ä¸­é¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ä¸²å£å“åº”ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æœ¬æ¬¡å¾ªç¯ç”¨æ¥å¤„ç†æ¶ˆæ¯å“
             -åº” */
  44   2              if(receiveCmdNotify == 1){
  45   3                  receiveCmdNotify = 0;
  46   3      
  47   3                  receiveEventFunction();     //æ¥ä½æ¶ˆæ¯
  48   3      
  49   3                  //éƒ½å¤„ç†å®Œäº†æ‰“å¼€RENæ¥å—ä¸²å£ä¿¡å·ï¼Œç»§ç»­ä¸»å¾ªç¯
  50   3                  if(!REN)
  51   3                      REN = 1;
  52   3                  continue;
  53   3              }
  54   2      
C51 COMPILER V9.52.0.0   FINGURE                                                           03/07/2017 18:03:37 PAGE 2   

  55   2              /*
  56   2               * å¦‚æœæ²¡æœ‰ä¸²å£å“åº”
  57   2               * é¦–å…ˆåˆ¤æ–­æ˜¯å¦åœ¨ç­‰å¾…ä¸‹ä½æœºåé¦ˆï¼Œå¦‚æœåœ¨ç­‰å¾…ï¼Œå°±å¼€å§‹å»¶æ—¶è®¡æ•°
  58   2               */   
  59   2              if(waitForReceive == 1){
  60   3                  if(waitTimes <3)
  61   3                      waitForReceiveFunction();
  62   3                  else
  63   3                      resetFingureFunction();
  64   3                  continue;
  65   3              }
  66   2      
  67   2              /* 
  68   2               * ç»§ç»­åˆ¤æ–­P2å£æœ‰æ²¡æœ‰å½•å…¥é€šçŸ¥
  69   2               * å¦‚æœæœ‰å½•å…¥é€šçŸ¥ï¼Œå¹¶ä¸”å½“å‰çŠ¶æ€ä¸ºéªŒè¯çŠ¶æ€ï¼Œåˆ™å‘é€å½•å…¥å‘½ä»¤
  70   2               * å¦‚æœæ²¡æœ‰å½•å…¥é€šçŸ¥ï¼Œåˆ™å‘é€éªŒè¯å‘½ä»¤
  71   2               */
  72   2              inputSignal = checkInputSignal();
  73   2              if((sendCmdStatus ==  ACTION_GET_IMAGE_FOR_CHECK) && inputSignal){
  74   3                  sendCmdStatus = ACTION_GET_IMAGE_FOR_INPUT1;
  75   3              }
  76   2      
  77   2              sendCmdFunction();
  78   2              delay(65535);
  79   2          }
  80   1      }
  81          
  82          /**
  83           * ä¸²å£ä¸­æ–­å‡½æ•°ï¼Œç”¨æ¥æ¥æ”¶ä¸‹ä½æœºæ•°æ®
  84           */
  85          void serialInterruptCallback() interrupt 4 {
  86   1        if(RI){       //æœ¬æ¬¡ä¸­æ–­æ˜¯æ¥å—ä¸­æ–­
  87   2          RI = 0;     //æ¥å—å®Œäº†æ¸…é›¶
  88   2      
  89   2              //å°†æ¥å—åˆ°çš„å­—èŠ‚è¿½åŠ åˆ°æŒ‡ä»¤æ¥å—ç¼“å†²åŒº
  90   2          receiveByte = SBUF;
  91   2          receiveBuffer[receiveBufferLength] = receiveByte;
  92   2              receiveBufferLength++;
  93   2      
  94   2              if(receiveBufferLength == 9){
  95   3                  //å¦‚æœæŒ‡ä»¤æ¥å—åˆ°9ä¸ªbyteï¼Œè¿™æ—¶å€™åŒ…é•¿åº¦ä¿¡æ¯æœ‰äº† 
  96   3                  //@TODO:æ¥å—åˆ°9ä¸ªå­—èŠ‚åï¼Œå¯ä»¥å†åˆ¤æ–­ä¸€ä¸‹åŒ…å¤´ä¿¡æ¯æ˜¯å¦ç¬¦åˆè¦æ±‚
  97   3                  receivePackageLength = (receiveBuffer[7] << 8) + receiveBuffer[8];
  98   3              }else if (receiveBufferLength == 9 + receivePackageLength) {
  99   3                  //ç»“æŸä¸€è½®æ¶ˆæ¯æ¥å—ï¼Œæ¸…ç©ºbufferï¼Œè§£æå‘½ä»¤
 100   3                  
 101   3                  //è·å–æ ¡éªŒå’Œ
 102   3                  receiveCheckSum = (receiveBuffer[7 + receivePackageLength] << 8) + receiveBuffer[8 + receivePa
             -ckageLength];
 103   3                  //è·å–ç¡®è®¤ç 
 104   3                  cfmCode = receiveBuffer[9];
 105   3                  //è·å–å‚æ•°
 106   3                  for (ucharTemp = 0; ucharTemp < receivePackageLength - 3; ucharTemp++) {
 107   4                      receiveParams[ucharTemp] = receiveBuffer[10 + ucharTemp];
 108   4                  }
 109   3      
 110   3                  //éªŒè¯æ ¡éªŒå’Œ
 111   3                  uintTemp = 0;
 112   3                  for (ucharTemp = 6; ucharTemp < receiveBufferLength - 2; ucharTemp++) {
 113   4                      uintTemp += receiveBuffer[ucharTemp];
 114   4                  }
 115   3                  if (uintTemp == receiveCheckSum) {
C51 COMPILER V9.52.0.0   FINGURE                                                           03/07/2017 18:03:37 PAGE 3   

 116   4                      //æ ¡éªŒæ­£ç¡®ï¼Œå‘å°„æ¶ˆæ¯å“åº”
 117   4                      receiveCmdNotify = 1;
 118   4      
 119   4                      receiveEventStatus = sendCmdStatus - 10;    //äº‹ä»¶ç±»å‹æ ¹æ®å‘é€ç±»å‹å¯¹åº”
 120   4                      waitForReceive = 0;                         //è§£é™¤ç­‰å¾…é”
 121   4                      waitTimes = 0;                              //ç­‰å¾…å“åº”æ¬¡æ•°å¤ä½
 122   4      
 123   4                      REN = 0;    //å¿…é¡»æ¶ˆæ¯å“åº”åæ‰èƒ½ç»§ç»­æ¥å—ï¼Œæ¥å—å“åº”åéœ€è¦äººå·¥å°†RENå
             -¤ä½ä¸º1
 124   4                  }
 125   3                  //æ¸…ç©ºæŒ‡ä»¤buffer
 126   3                  receiveBufferLength = 0;
 127   3              }            
 128   2        }
 129   1      }
 130          
 131          /* ç»™sendBufferå˜é‡æ„å»ºå‘é€æŒ‡ä»¤ */
 132          void buildSendCmd(uchar* cmdAndParams, uchar capLength){
 133   1          uint checkSum;
 134   1          uchar packageLength = capLength + 2;    //åŒ…é•¿åº¦ = æŒ‡ä»¤é›†é•¿åº¦ + æ ¡éªŒå’Œé•¿åº¦
 135   1          sendBufferLength = 11 + capLength;      // 7 + 2 + capLength + 2
 136   1      
 137   1          sendCmd = cmdAndParams[0];              //å‘½ä»¤ä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚
 138   1      
 139   1          sendBuffer[7] = 0;                      //åŒ…é•¿åº¦é«˜ä½ä¸º0x00
 140   1          sendBuffer[8] = packageLength;          //åŒ…é•¿åº¦ä½ä½ä¸ºå®é™…åŒ…é•¿åº¦
 141   1          
 142   1          //æ„å»ºå‘é€æŒ‡ä»¤ä¸²å£æ¶ˆæ¯ä¸­çš„æŒ‡ä»¤å’Œå‚æ•°
 143   1          for(ucharTemp = 0; ucharTemp < capLength; ucharTemp++){
 144   2              sendBuffer[9+ucharTemp] = cmdAndParams[ucharTemp];
 145   2          }
 146   1      
 147   1          checkSum = getCheckSum(packageLength, cmdAndParams, capLength);
 148   1          sendBuffer[9 + capLength] = checkSum>>8;
 149   1          sendBuffer[10 + capLength] = checkSum;
 150   1      }
 151          
 152          /**
 153           * [è®¡ç®—æ ¡éªŒå’Œ]
 154           * @param  packageLength [åŒ…é•¿åº¦]
 155           * @param  cmdAndParams  [å‘½ä»¤å’Œå‚æ•°æ•°ç»„]
 156           * @param  capLength     [å‘½ä»¤å’Œå‚æ•°é•¿åº¦]
 157           * @return               [2byte æ ¡éªŒå’Œ]
 158           */
 159          uint getCheckSum(uchar packageLength, uchar* cmdAndParams, uchar capLength){
 160   1          uintTemp = packageLength;
 161   1          for(ucharTemp = 0; ucharTemp < capLength; ucharTemp++){
 162   2              uintTemp += cmdAndParams[ucharTemp];
 163   2          }
 164   1          return uintTemp + 1;
 165   1      }
 166          
 167          /**
 168           * æ£€æŸ¥è¾“å…¥ç«¯å£æœ‰æ²¡æœ‰å½•å…¥ä¿¡å·ï¼ˆP2é«˜4ä½ï¼‰,å½•å…¥ä¿¡å·éœ€è¦é˜¶æ®µæ—¶é—´å†…ç»´æŒç¨³å®šä¿¡
             -å·
 169           * @return å¦‚æœæ²¡æœ‰ï¼Œè¿”å›0ï¼Œå¦‚æœæœ‰ï¼Œè¿”å›P2é«˜4ä½çš„ä½ä¸‰ä½ä½œä¸ºæƒé™æ•°æ®
 170           */
 171          uchar checkInputSignal(){
 172   1          uchar inputValue = GPIO_INPUT;
 173   1          uintTemp = 500;
 174   1      
 175   1          while(uintTemp--){
C51 COMPILER V9.52.0.0   FINGURE                                                           03/07/2017 18:03:37 PAGE 4   

 176   2              ucharTemp = (inputValue>>4);
 177   2              if(!ucharTemp)
 178   2                  return 0x00;
 179   2          }
 180   1      
 181   1          return ucharTemp;
 182   1      }
 183          
 184          /* æ ¹æ®receiveEventStatusï¼Œè§£æä¸²å£å“åº” */
 185          void receiveEventFunction(){
 186   1          switch(receiveEventStatus){
 187   2              case EVENT_GET_IMAGE_FOR_CHECK:
 188   2                  if(cfmCode == 0){
 189   3                      //ä¼ æ„Ÿå™¨é‡‡é›†åˆ°æŒ‡çº¹
 190   3                      sendCmdStatus = ACTION_BUILD_CB1_FOR_CHECK;
 191   3                  }else if(cfmCode == 2){ 
 192   3                      //ä¼ æ„Ÿå™¨ä¸Šæ²¡æœ‰æ‰‹æŒ‡ï¼Œå»¶æ—¶åç»§ç»­å‘é€é‡‡é›†å‘½ä»¤
 193   3                      sendCmdStatus = ACTION_GET_IMAGE_FOR_CHECK;
 194   3                      delay(3000);
 195   3                  }
 196   2                  break;
 197   2              case 2:
 198   2                  break;
 199   2          }
 200   1      }
 201          
 202          /* æ ¹æ®sendCmdStatusï¼Œæ„é€ å‘é€å‘½ä»¤ */
 203          void sendCmdFunction(){
 204   1          uchar test[] = {0x01};
 205   1          switch(sendCmdStatus){
 206   2              case ACTION_GET_IMAGE_FOR_CHECK:
 207   2                  buildSendCmd(test, 1);
 208   2                  uartSendBuffer(sendBuffer, sendBufferLength);
 209   2                  break;
 210   2              case 2:
 211   2                  break;
 212   2          }
 213   1      
 214   1          /* å‘é€å®Œæˆåï¼Œç«‹åˆ»å°†æ¥å—ç­‰å¾…æ ‡å¿—ç½®1ï¼Œç­‰å¾…æ¥å— */
 215   1          receiveEventStatus = 0;
 216   1          waitForReceive = 1;
 217   1          REN = 1;
 218   1      }
 219          
 220          /* ç­‰å¾…ä¸‹ä½æœºåé¦ˆçš„å»¶æ—¶è®¡æ•°å‡½æ•° */
 221          void waitForReceiveFunction(){
 222   1          waitTimes++;
 223   1          delay(500);
 224   1      }
 225          
 226          /* å¯¹æŒ‡çº¹æ¨¡å—çš„å¤ä½å‡½æ•° */
 227          void resetFingureFunction(){
 228   1          waitTimes = 0;
 229   1      
 230   1          //@TODO:æ§åˆ¶å¼•è„šè®©æŒ‡çº¹ä¸‹ä½æœºå¤ä½
 231   1      
 232   1          delay(65535);
 233   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    649    ----
C51 COMPILER V9.52.0.0   FINGURE                                                           03/07/2017 18:03:37 PAGE 5   

   CONSTANT SIZE    =      8    ----
   XDATA SIZE       =    128    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     39      10
   IDATA SIZE       =     76    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
